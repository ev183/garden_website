name: Destroy running ECS tasks

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  destroy-tasks:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:

    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Check running ECS tasks
      id: ecs_tasks

      run: |
        COUNT=$(aws ecs list-tasks \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service-name ${{ secrets.ECS_SERVICE }} \
          --desired-status RUNNING \
          --region ${{ secrets.AWS_REGION }} \
          --query 'length(taskArns)' \
          --output text)
        echo "count=$COUNT" >> $GITHUB_OUTPUT

    - name: Destroy running ECS tasks
      if: ${{ steps.ecs_tasks.outputs.count != '0' }}
      run: |
        echo "Setting desired count to 0..."
        aws ecs update-service \
          --cluster ${{ secrets.ECS_CLUSTER }} \
          --service ${{ secrets.ECS_SERVICE }} \
          --desired-count 0

    - name: Skip deployment (no running tasks)
      if: ${{ steps.ecs_tasks.outputs.count == '0' }}
      run: echo "No running tasks â€” skipping task destruction."